<html>
<script type="text/javascript" src="http://www.google.com/jsapi"></script>
<script type="text/javascript" src="js/jquery-1.4.4.min.js"></script>
<script type="text/javascript" src="js/jquery.url.js"></script>
<script type="text/javascript" src="js/formData.js"></script>
<head>
	<script>
	//blogger api needs to be retrieved in a head block.
	google.load("gdata", "1.1");
	google.setOnLoadCallback(runAfterLibLoad);
	
///TODO: Fix problems getting data from authors.
	/**
	 * Call back which can run after the api has been loaded from blogger. Retrieves data
	 * if doing update and pass on to popup.
	 */
	function runAfterLibLoad(){
				
	}
	</script>
</head>
  <script>
	var BLOGGER = "www.blogger.com";
	var BLOGGER_POST = "/post-edit.g";
	var BLOGGER_CREATE = "/post-create.g";

	
	/**
	 * //Cant use Chrome with the Blogger api with out getting an ugly popup... so odd come on google really?
	 * Moving output to the popup to display for copy/paste
	 */
	function processData(data) {
		var currentURL = "";
		//debug		
		var toString = "rec-name:"+ data.$recname + " ingrediants:"+ data.$ingredients + " yield:" + data.$yield;
		debug("got data:  "+toString)

		var hRecipeCode = convertTohRecipe(data);
		debug("hrecipe=="+hRecipeCode);
		
		return hRecipeCode;
		//chrome.tabs.executeScript(null, {code:"updateText('"+hRecipeCode+"')"})		
		debug("done");
	}

//TODO:clean up junk below.	
	/**
	 * Looks at the URL to determine what should be done given the action type of 'load' or 'post',
	 * based on the site in current browser tab. 
	 *
	 * This might still be useful for knowing where to get data for loading but then again maybe goign 
	 * off the current field is enough.?
	 * @param - actionType ('load'|'post')
	 */
	function checkURLAction(actionType){	
		chrome.tabs.getSelected(null, function(tab) {    
		var url = tab.url;						
		jQuery.url.setUrl(url)
		console.log("HOST="+jQuery.url.attr("host"));

		//TODO: get selected text field and post code to there, if none selected then err
			if("load" == actionType) {
				populateFieldData();

			}
			else if("post" == actionType) {
				console.log('NO BLOGGER POST');
				var hRecipeCode = convertTohRecipe(data);
				console.log("hrecipe=="+hRecipeCode);
				//var currField == document.activeElement;
				chrome.tabs.executeScript(null, {code:"updateText('TESTER')"})
				chrome.tabs.executeScript(null, {code:"console.log('active=='+document.activeElement)"})
			}

		});   
	}
	
	/**
	 * Inspect the provided html, parse out hRecipe data if present and sets form fields.
	 */
	function populateFieldData() {
		//TODO: you know what to do!
	}

	/**
	 * Converts data to the hRecipe format with default formatting tags.
	 */
	function convertTohRecipe(data) {
		var microformat = "<div class=\"hrecipe\">";
		if(data){
			
			microformat += ("<h1 class=\"fn\">" + data.$recname + "</h1>");
			if(data.$summary) microformat += ("<p class=\"summary\">" + data.$summary + "</p>");
			if(data.$authors.length>0) microformat += ("<p class=\"authors\">" + data.$authors[0].value + "</p>");
			if(data.$published) microformat += ("<p>Published <span class=\"published\">" + data.$published + "</span></p>");
			if(data.$photos.length>0) {
				microformat += ("<img src=\"" + data.$photos[0] + "\" class=\"photo\" width=\"100\" height=\"100\" alt=\"Pommes Frites\"/>");
			}
			microformat +="<h2>Ingredients</h2>"
			microformat +="<ul>"
			for(i in data.$ingredients) {
				microformat += ("<li class=\"ingredient\">" + data.$ingredients[i] + "</li>");
			}
			microformat +="</ul>"
			
			if(data.$instructions) {
				microformat +="<h2>Instructions</h2>"
				microformat += ("<span class=\"instructions\">" + data.$instructions + "</span>");
			}
			
			if(data.$yield) microformat += ("<p>Yield:<span class=\"yield\">"+data.$yield+"</span></p>");
			if(data.$durations.length>0) microformat += ("<p>Preparation time is approximately <span class=\"duration\">" + data.$duration[0] + "</span></p>")
			
			if(data.$nutritions.length>0) {
				microformat +="<h2>Nutrition</h2>";
				microformat +="<p>";
				for(n in data.$nutritions) {
					microformat += ("<span class=\"nutrition\">" + data.$nutritions[n] + "</span>");
				}
				microformat +="</p>";
			}    
		}
		
		microformat += "</div>";
		return microformat;
	}


  </script>
</html>
