<html>

<script type="text/javascript" src="js/jquery-1.4.4.min.js"></script>
<script type="text/javascript" src="js/jquery.url.js"></script>
<script type="text/javascript" src="js/formData.js"></script>

<script>
	var BLOGGER = "www.blogger.com";
	var BLOGGER_POST = "/post-edit.g";
	var BLOGGER_CREATE = "/post-create.g";

	
	/**
	 * //Cant use Chrome with the Blogger api with out getting an ugly popup... so odd, come on google really?
	 * Moving output to the popup to display for copy/paste
	 */
	function processData(data) {
		var currentURL = "";
		//debug		
		var toString = "rec-name:"+ data.$recname + " ingrediants:"+ data.$ingredients + " yield:" + data.$yield;
		debug("got data:  "+toString)

		var hRecipeCode = convertTohRecipe(data);
		debug("hrecipe=="+hRecipeCode);
		
		return hRecipeCode;
		//chrome.tabs.executeScript(null, {code:"updateText('"+hRecipeCode+"')"})		
		debug("done");
	}

//TODO:clean up method below.	
	/**
	 * Looks at the URL to determine what should be done given the action type of 'load' or 'post',
	 * based on the site in current browser tab. 
	 *
	 * This might still be useful for knowing where to get data for loading but then again maybe goign 
	 * off the current field is enough.?
	 * @param - actionType ('load'|'post')
	 */
	function checkURLAction(actionType){	
		chrome.tabs.getSelected(null, function(tab) {    
		var url = tab.url;						
		jQuery.url.setUrl(url)
		debug("HOST="+jQuery.url.attr("host"));

		//TODO: get selected text field and post code to there, if none selected then err
			if("load" == actionType) {
				populateFieldData();

			}
			else if("post" == actionType) {
				debug('NO BLOGGER POST');
				var hRecipeCode = convertTohRecipe(data);
				debug("hrecipe=="+hRecipeCode);
				//var currField == document.activeElement;
				chrome.tabs.executeScript(null, {code:"updateText('TESTER')"})
				chrome.tabs.executeScript(null, {code:"console.log('active=='+document.activeElement)"})
			}

		});   
	}
	
	/**
	 * Inspect the provided html, parse out hRecipe data if present and sets form fields.
	 */
	function populateFieldData() {
		//TODO: you know what to do!
	}

	/**
	 * Converts data to the hRecipe format with default formatting tags.
	 */
	function convertTohRecipe(data) {
		var microformat = "<div class=\"hrecipe\">\n";
		if(data){
			
			microformat += ("<h1 class=\"fn\">" + data.$recname + "</h1>\n");
			if(data.$summary) microformat += ("<p class=\"summary\">" + data.$summary + "</p>\n");
			if(data.$author) microformat += ("<p class=\"author\">" + data.$author + "</p>\n");
			if(data.$published) microformat += ("<p>Published <span class=\"published\">" + data.$published + "</span></p>\n");
			if(data.$photos.length>0) {
				microformat += ("<img src=\"" + data.$photos[0] + "\" class=\"photo\" style=\"height:140px;width:140px;border-width:0px;\" alt=\"" + data.$recname + "/>\n");
			}
			microformat +="<h2>Ingredients</h2>\n"
			microformat +="<ul>\n"
			for(i in data.$ingredients) {
				microformat += ("<li class=\"ingredient\">" + data.$ingredients[i] + "</li>\n");
			}
			microformat +="</ul>\n"
			
			if(data.$instructions) {
				microformat +="<h2>Instructions</h2>\n"
				microformat += ("<span class=\"instructions\">" + data.$instructions + "</span>\n");
			}
			
			if(data.$yield) microformat += ("<p>Yield:<span class=\"yield\">"+data.$yield+"</span></p>\n");
			
			if(data.$preptime || data.$cooktime) {
				microformat += "<span class=\"duration\">\n";
				var prep = "0M";
				var cook = "0M";
				
				
				if(data.$preptime) {
					prep = parseTime(data.$preptime);
					microformat += ("<p>Prep Time:<span class=\"preptime\"><span class=\"value-title\" title=\""+prep+"\"></span>"+data.$preptime+"</span></p>\n");
					
				}
				if(data.$cooktime) {
					cook = parseTime(data.$cooktime);
					microformat += ("<p>Cook time:<span class=\"cooktime\"><span class=\"value-title\" title=\""+cook+"\"></span>"+data.$cooktime+"</span></p>\n");				
				}
				
				microformat += "</span>\n";
			}
			
			
			
			if(data.$nutritions.length>0) {
				microformat +="<h2>Nutrition</h2>\n";
				microformat +="<p>\n";
				microformat +="<span class=\"nutrition\">"
				for(n in data.$nutritions) {
					microformat += "<span class=\""+ (data.$nutritionTypes[n].replace(" ","")).toLowerCase() + "\">" +(data.$nutritions[n] + "</span>\n");
				}
				microformat +="</span>\n</p>\n";
			}    
		}
		
		microformat += "</div>";
		return microformat;
	}

	/**
	 * Parse method expects to recieve time formatted in the hh:mm format and simply yanks out the : and adds markers
	 */
	function parseTime(timeValue) {
		var result = "PT";
		var timeSplit = timeValue.split(":");
		if(timeSplit.length == 2) {
			result += (timeSplit[0]+"H"+timeSplit[1]+"M");
		} else {
			result += (timeValue+"M");
		}		
		
		return result;
	}
  </script>
</html>
