<link type="text/css" href="css/le-frog-cust/jquery-ui-1.8.10.custom.css" rel="Stylesheet" />	
<link type="text/css" href="css/form-style.css" rel="Stylesheet" />	
<script type="text/javascript" src="js/jquery-1.4.4.min.js"></script>
<script type="text/javascript" src="js/jquery-ui-1.8.10.custom.min.js"></script>
<script type="text/javascript" src="js/jquery.url.js"></script>
<script type="text/javascript" src="js/jquery.validate.min.js"></script>
<script type="text/javascript" src="js/formData.js"></script>
<script>

//TODO: Add save data to localstorage in case of accidentally closing.
//TODO: Add clear button to reset form if data was left in local storage.
//TODO: Add toggle to switch between pure hRecipe Spec and the Google version.
//TODO: Consider adding a non-formatting option that uses all span tags so users can style their own.
//TODO: reverse parse to populate from current page/field for editing.
//TODO: Find some graphics!
//TODO: Add Options/About Tab (Allow toggle of save previous data and when to discard. (no save, only if already generated hRecipe, only on clear button.))
//TODO: move scripts to js file once done testing

//DONE: make Ingredients field long.
//DONE: Add hRecipe format for nutrition types. Look into diff on value/type tags
//DONE: test duration validation, it should NOT allow "40 min" as an entry.
//DONE: get NutritionType data from form and putput in right format
//DONE: fix addField so Select is in the nutrition specific function.
//DONE: Add Nutrition type drop down to specify Calories, fat, Total Carbs, Dietary Fiber, protein, sodium, Cholesterol
//DONE: Add proper value-title tags for the duration times so google will parse it. ex: <span class="value-title" title="PT1H30M"></span> (PT1H30M ? does the PT stand for Pacific time or something else?)
//DONE: finish time formatter in background for duration types
//DONE: Add validations (durations- require hh:mm format)
//DONE: add duration types (preptime, cooktime, also compute total 'duration' )
//DONE: Fix Author output
//DONE: fix Duration Output.

	var nutritionTypes = ["Calories", "Fat", "Total Carbs", "Dietary Fiber", "Protein", "Sodium", "Cholesterol"];

	/**
	 * Initializes the Form after load.
	 */
	function initForm() {
		console.log("Load Blog posting.");
		chrome.extension.getBackgroundPage().checkURLAction('load');
		$('#published').datepicker();
		$('#ok').button();
		$('#done').button();
		$('#close').button();
		$('#clear').button();
		$('#copy').button();
		$( "#tabs" ).tabs({
	    	show: function(event, ui) { 		
		 	}
		});
		$( "#tabs" ).bind( "tabsshow", function(event, ui) {
			if(ui.panel.id == "tabs-2") {
				debug("Got Tab");
				var formData = initData();
				if($("#recipeForm").valid() && formData){
					var output = chrome.extension.getBackgroundPage().processData(formData);
					debug("output="+output);
					$('#results').val(output);
				} else {
					//fails validation, switch back to input form
					$( "#tabs" ).tabs('select',0);
				}
			}
		});

    	$("#recipeForm").validate({
			rules: {
			 // simple rule, converted to {required:true}
				recName: {
				 	required: true,
				 	minlength: 2
				 },
				ingredient0: {
					required: true,
				 	minlength: 2
				},
				cooktime: {
				 	checkTime:true
			 	},
			 	preptime: {
					checkTime:true
			 	}
		   },
		   messages: {
			 recName: {
			   required: "A recipe Title is required.",
			   minlength: jQuery.format("At least {0} characters required!")
			 },
			 ingredient0: {
			   required: "Requires 1 ingrediant.",
			   minlength: jQuery.format("At least {0} characters required!")
			 }			 
		   },
		   errorClass: "ui-state-highlight",
		   focusCleanup: true,
		   wrapper: "div"
		});
		
		//Add a time check function.		
		$.validator.addMethod('checkTime', function( value, element, params ) {
			if(/^([0-9]?[0-9])$/.test(value))
				return true; //if just 1-2 digits then its ok assuem mins.
			return ((value.length >= 1 )? /^(([0-1]?[0-9])|([2][0-3])):([0-5]?[0-9])(:([0-5]?[0-9]))?$/.test(value):true)
		}, "Times should be in the hh:mm format.");
		
		appendNutritionTypes("nutritionType");
		
		
		loadFromLocalStore()
	}
	
	function loadFromLocalStore() {
		var objStr = localStorage["hRecipeData"];
console.log("loadedData == "+objStr);
		if(objStr && objStr.length >2){
			var formDataParse = jQuery.parseJSON(objStr);
			//var formData = JSON.parse();//new FormData();
			console.log("formDataParse == "+formDataParse + " name==" + formDataParse.$recName);
		}
	/*	for(var prop in (formData)) {
			if(formData.hasOwnProperty(prop)) {
				var tag = prop.replace("$","");

				var locValue = localStorage[tag];
console.log("LoadTag=="+tag + "  Val==" +locValue  );
				$('#'+tag).val(locValue);
			}
		}*/
	}

	function saveToLocalStore(formData) {
		localStorage["hRecipeData"] = JSON.stringify(formData);
				
		
/*		var myObj = {"key":"value", "key2":"value2","key3":"value3", $value:"value$"}
		console.log(JSON.stringify(formData));

		for(var prop in (formData)) {
			if(formData.hasOwnProperty(prop)) {
				var tag = prop.replace("$","");
				console.log("tag=="+tag);
				localStorage[tag] = formData[prop];
			}	
		}*/
	}

	function clearFormData() {
		var formData = new FormData();
		for(var prop in (formData)) {
			if(formData.hasOwnProperty(prop)) {
//				console.log(prop + " == "+ formData[prop]);
				localStorage.removeItem(prop);
			}
		}
	}

	$(document).ready(initForm);
	
	/**
	 * collect data and create dto.
	 */
	function initData() {

		console.log("is valid=="+	$("#recipeForm").valid());

		var formData = new FormData();		
		formData.$recname = $('#recName').val();	
		var inglist = getFormArray('ingredient');
		
		inglist.unshift($('#ingredient0').val());
		formData.$ingredients = inglist;
		formData.$yield = $('#yield').val();
		formData.$cooktime = $('#cooktime').val();
		formData.$preptime = $('#preptime').val();
		formData.$photos = [$('#photo').val()];
		formData.$author = $('#author').val();
		formData.$published = $('#published').val();
		formData.$instructions = $('#instructions').val();
		
		formData.$nutritionTypes = $("[id^=nutritionType]").map(function(){return $(this).val();}).get();
		formData.$nutritions = getFormArray('nutrition');
		formData.$summery = $('#summery').val();
		formData.$tags = $('#tag').val();
		
		saveToLocalStore(formData)
		return formData;
	}	

	/**
	 * Retrieve array of data values for same name input fields.
	 */
	function getFormArray(id) {
		return $("input[id='"+id+"']").map(function(){return $(this).val();}).get();
	}

	/**
     * Adds new nutrition input fields
     */
	function appendNutrition() {
		var elmtNumber = addFormField('nutrition', true);		
		appendNutritionTypes('nutritionType'+elmtNumber);
	}

	/**
 	 * Adds the array of Types to the new select
	 */
	function appendNutritionTypes(nutritionFieldName) {
		var output = [];

		$.each(nutritionTypes, function(key, value) 	{
		  	output.push('<option value="'+ value +'">'+ value +'</option>');
		});

		$("."+nutritionFieldName).html(output.join(''));
	}
	
	/**
	 * Adds array type field to form.
	 * @return - element name where added
	 */
	function addFormField(fieldName, addSelect) {
		var rowCt = $("#"+fieldName + "List li").size();
		debug(rowCt);
		var newElmName = (fieldName + "Row"+rowCt);
		
		var newHtml = "<li id='"+newElmName+"'><input type=\"text\" id=\""+fieldName+"\" name=\""+ fieldName+"\" "
		if(addSelect) {
			newHtml += "/> <select id=\""+fieldName+"Type\" class=\""+fieldName+"Type"+ rowCt + "\"></select>";
		} else {
			newHtml += " class=\"large-field\"/>";
		}
		newHtml += "</li>";
		
		$("#"+fieldName + "List").append(newHtml);
		$("#"+fieldName + "Row"+rowCt).effect("highlight", {}, 3000);		
		return rowCt;
	}
	
	

	//enable tabs
	$(function() {
		$( "#tabs" ).tabs();
	});	
		
</script>

<html>
<head>
</head>
<body>
 <form class="cmxform" id="recipeForm" method="get" action="">
<div id="tabs">
	<ul>
		<li><a href="#tabs-1">Edit Recipe</a></li>
		<li><a href="#tabs-2">hRecipe Results</a></li>
	</ul>
	<div align="right"><input type="button" id="clear" value="Clear" onClick='clearFormData();'> <input type="button" id="done" value="Close" onClick='window.close();'></div>
	<div id="tabs-1">
		<table>
			<tr><th><label for="recName">Title</label></th><td><input type="text" id="recName" name="recName" class="large-field"/></td></tr>
			<tr><th><label for="author">Author</label></th><td><input type="text" id="author" name="author"  class="large-field"/></div></td></tr>
			<tr><th><label for="published">Published</label></th><td><input type="text" id="published" name="published"/></td></tr>
			<tr><th><label for="yield">Yield</label></th><td><input type="text" id="yield" name="yield"/></td></tr>
			<tr><th><label for="summery">Summery</label></th><td><textarea id="summery" name="summery" rows="3" cols="30"></textarea></td></tr>
			<tr><th><label for="ingredient">Ingredients </label></th><td><a href="#" onClick="addFormField('ingredient'); return false;">add</a></td><tr>
			<tr><td colspan=2>
			<ul id='ingredientList'>
				<li><input type="text" id="ingredient0" name="ingredient0" class="large-field"/></li>
			</ul>
			</td></tr>
			<tr><th colspan=2><label for="instructions">Instructions</label></th>
			<tr><td colspan=2><textarea id="instructions" name="instructions" rows="6" cols="43"></textarea></td></tr>
			<tr><th><label for="preptime">Prep Time</label></th><td><input type="text" id="preptime" name="preptime" class="large-field"/></td></tr>
			<tr><th><label for="cooktime">Cook Time</label></th><td><input type="text" id="cooktime" name="cooktime" class="large-field"/></td></tr>
			<tr><th><label for="photo">Photo</label></th><td><input type="text" id="photo" name="photo"  class="large-field"/></td></tr>
			<tr><th><label for="nutrition">Nutrition </label></th><td><a href="#" onClick="appendNutrition(); return false;" alt="Add another">add</a></td></tr>
			<tr><td colspan=2>		
			<ul id='nutritionList'>
				<li><input type="text" id="nutrition" name="nutrition"/> <select id="nutritionType" class="nutritionType"></select></li>
			</ul>
			</td></tr>
			<tr><th><label for="tag">Tags</label></th><td><input type="text" id="tag" name="tag" class="large-field"/></td></tr>
		</table>
</form>
	</div>
	<div id="tabs-2">
		<div><label for="results">Results</label><textarea id="results" name="results" rows="20" cols="40"></textarea></div>
	</div>
</body>
</html>
